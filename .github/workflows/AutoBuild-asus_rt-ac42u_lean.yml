###########################################################
#   Description: Compile OpenWrt by GitHub Actions        #
#   Based on: https://github.com/P3TERX/Actions-OpenWrt   #
#   Author: Hyy2001X                                      #
###########################################################

name: ASUS RT-ACRH17 (ledeç‰ˆ)

### ç•Œé¢æ§åˆ¶éƒ¨åˆ† ( ä»¥ä¸‹å†…å®¹è¯·ä¿æŒä¸å˜ )
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      Tempoary_IP:
        description: 'å›ºä»¶ IP åœ°å€ [å¯é€‰]'
        default: ''
      Tempoary_CONFIG:
        description: 'é…ç½®æ–‡ä»¶ [å¯é€‰]'
        default: ''
      Tempoary_FLAG:
        description: 'å›ºä»¶æ ‡ç­¾ [å¯é€‰]'
        default: ''
      UPDATE_CONTENT:
        description: 'æ›´æ–°å†…å®¹æè¿°ï¼ˆæ”¯æŒ Markdownï¼‰'
        default: ''
### ç•Œé¢æ§åˆ¶éƒ¨åˆ†ç»“æŸ ( ä»¥ä¸Šå†…å®¹è¯·ä¿æŒä¸å˜ )

  ## Git Push æ—¶è§¦å‘ç¼–è¯‘(ä¸è¦åˆ é™¤æ­¤è¡Œæ³¨é‡Š)
  #push:
  #  branches: 
  #    - master
  
  ## å®šæ—¶è§¦å‘ç¼–è¯‘(ä¸è¦åˆ é™¤æ­¤è¡Œæ³¨é‡Š)
  #schedule:
  #  - cron: 0 8 * * 5
  
  ## é‡æ–°ç‚¹äº® Star æ—¶è§¦å‘ç¼–è¯‘(ä¸è¦åˆ é™¤æ­¤è¡Œæ³¨é‡Š)
  #watch:
  #  types: [started]

### è¯·æŒ‰éœ€æ±‚ä¿®æ”¹ä»¥ä¸‹å†…å®¹
### ç¯å¢ƒå˜é‡è®¾ç½®
env:
# ç¼–è¯‘æ—¶è°ƒç”¨çš„ [.config] æ–‡ä»¶åç§°
  CONFIG_FILE: asus_rt-ac42u
# æºç ä»“åº“:åˆ†æ”¯
  DEFAULT_SOURCE: coolsnowwolf/lede:master
# ä¸Šä¼ å›ºä»¶åˆ° Github Releases
  UPLOAD_RELEASES: true
# ä¸Šä¼ å›ºä»¶åˆ° Github Artifacts
  UPLOAD_ARTIFACTS: false
# ä¸Šä¼  bin æ–‡ä»¶å¤¹åˆ° Github Artifacts
  UPLOAD_BIN_ARTIFACTS: false
# åˆ é™¤æ— ç”¨æ–‡ä»¶ä»¥å¢åŠ ç¼–è¯‘ç©ºé—´
  DELETE_USELESS_FILES: true
# åˆ é™¤æ—©æœŸçš„ workflow ä»»åŠ¡
  DELETE_OLD_WORKFLOW: true
# Cache åŠ é€Ÿç¼–è¯‘
  CACHE_ACCELERATE: true
# æ—¶åŒº
  TZ: Asia/Shanghai
### ç»“æŸ
### è¯·æŒ‰éœ€æ±‚ä¿®æ”¹ä»¥ä¸Šå†…å®¹

jobs:
  Compile
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write

    steps:
    - name: "Optimize disk space"
      if: env.DELETE_USELESS_FILES == 'true' && !cancelled()
      uses: "hugoalh/disk-space-optimizer-ghaction@v0.8.0"
      with:
        operate_sudo: "True"
        general_include: ".+"
        general_exclude: |-
          ^GCC$
          ^G\+\+$
          Clang
          LLVM
        docker_include: ".+"
        docker_prune: "True"
        docker_clean: "True"
        apt_prune: "True"
        apt_clean: "True"
        homebrew_prune: "True"
        homebrew_clean: "True"
        npm_prune: "True"
        npm_clean: "True"
        os_swap: "True"

    - name: Free up disk space
      if: env.DELETE_USELESS_FILES == 'true' && !cancelled()
      uses: easimon/maximize-build-space@master
      with: 
        root-reserve-mb: 6000
        swap-size-mb: 1
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: Checkout
      uses: actions/checkout@main
      with:
        fetch-depth: 0

    - name: Load Custom Variables
      run: |
        if [ -n "${{ github.event.inputs.Tempoary_CONFIG }}" ]
        then
            if [ -f "$GITHUB_WORKSPACE/Configs/${{ github.event.inputs.Tempoary_CONFIG }}" ]
            then
                CONFIG_FILE=${{ github.event.inputs.Tempoary_CONFIG }}
            else
                CONFIG_FILE=${{ env.CONFIG_FILE }}
            fi
        else
            CONFIG_FILE=${{ env.CONFIG_FILE }}
        fi
        if [ ! -f "$GITHUB_WORKSPACE/Configs/$CONFIG_FILE" ]
        then
            echo "CONFIG_FILE: [/Config/$CONFIG_FILE] is not detected ..."
            exit 1
        else
            echo "CONFIG_FILE: [/Config/$CONFIG_FILE]"
            echo "CONFIG_FILE=$CONFIG_FILE" >> $GITHUB_ENV
        fi
        if [ -n "${{ github.event.inputs.Tempoary_IP }}" ]
        then
            echo "IP: [${{ github.event.inputs.Tempoary_IP }}]"
            echo "Tempoary_IP=${{ github.event.inputs.Tempoary_IP }}" >> $GITHUB_ENV
        fi
        if [ -n "${{ github.event.inputs.Tempoary_FLAG }}" ]
        then
            echo "FLAG: [${{ github.event.inputs.Tempoary_FLAG }}]"
            echo "Tempoary_FLAG=${{ github.event.inputs.Tempoary_FLAG }}" >> $GITHUB_ENV
        fi
        REPO_URL="https://github.com/$(cut -d \: -f 1 <<< ${{ env.DEFAULT_SOURCE }})"
        REPO_BRANCH=$(cut -d \: -f 2 <<< ${{ env.DEFAULT_SOURCE }})
        echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
        echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_ENV
        echo "Compile_Date=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
        echo "Display_Date=$(date +%Y/%m/%d)" >> $GITHUB_ENV
        if [ -n "${{ github.event.inputs.UPDATE_CONTENT }}" ]
        then
            echo "UPDATE_CONTENT=${{ github.event.inputs.UPDATE_CONTENT }}" >> $GITHUB_ENV
        fi

    - name: Initialize Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        sudo -E apt update
        sudo -E apt -y full-upgrade
        sudo -E apt-get -y install busybox build-essential cmake asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib g++-multilib p7zip p7zip-full msmtp libssl-dev texinfo libreadline-dev libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint ccache curl wget vim nano python3 python3-pip python3-ply haveged lrzsz device-tree-compiler scons antlr3 gperf intltool mkisofs rsync
        sudo -E apt -y autoremove --purge
        sudo -E apt clean
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Clone Openwrt Source Code
      run: |
        git clone -b $REPO_BRANCH $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Accelerate
      if: env.CACHE_ACCELERATE == 'true'
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: false
        toolchain: true
        skip: true
        clean: true
        prefix: ${{ github.workspace }}/openwrt

    - name: Run Diy Scripts
      run: |
        echo "Free space:"
        df -h
        chmod +x Scripts/AutoBuild_*.sh
        cd openwrt
        if [ "${{ env.CACHE_ACCELERATE }}" == true ]
        then
            echo -e "\nCONFIG_DEVEL=y\nCONFIG_CCACHE=y\n" >> $GITHUB_WORKSPACE/Configs/$CONFIG_FILE
        fi
        cp $GITHUB_WORKSPACE/Configs/$CONFIG_FILE .config
        source $GITHUB_WORKSPACE/Scripts/AutoBuild_DiyScript.sh
        source $GITHUB_WORKSPACE/Scripts/AutoBuild_Function.sh
        make defconfig
        Firmware_Diy_Start
        rm -f .config && cp $GITHUB_WORKSPACE/Configs/$CONFIG_FILE .config
        Firmware_Diy_Main
        Firmware_Diy
        Firmware_Diy_Other

    - name: Pre-download Libraries
      run: |
        cd openwrt
        ./scripts/feeds install -a
        make defconfig
        make download -j8

    - name: Build OpenWrt
      run: |
        cd openwrt
        make -j4 || make -j1 V=s
       # ä¿®å¤æ¡ä»¶åˆ¤æ–­å’Œå˜é‡è®¾ç½®
        if [ $? -eq 0 ];
        then
            echo "Compile_Result=true" >> $GITHUB_ENV
        else
            echo "Compile_Result=false" >> $GITHUB_ENV
        fi
        source $GITHUB_WORKSPACE/Scripts/AutoBuild_DiyScript.sh
        Generate_Update_Logs

    - name: Debug File Check
      if: env.Compile_Result == 'true' && !cancelled()
      run: |
        echo "æ£€æŸ¥å›ºä»¶å’Œæ—¥å¿—æ–‡ä»¶:"
        ls -lh openwrt/bin/Firmware/
        echo "Compile_Result å€¼ä¸º: ${{ env.Compile_Result }}"
    
    - name: Checkout Firmware
      if: env.Compile_Result == 'true' && !cancelled()
      run: |
        cd openwrt
        source $GITHUB_WORKSPACE/Scripts/AutoBuild_Function.sh
        Firmware_Diy_End

    - name: Upload Firmware to Artifacts
      uses: actions/upload-artifact@main
      if: env.UPLOAD_ARTIFACTS == 'true' && env.Compile_Result == 'true' && !cancelled()
      with:
        name: ${{ env.CONFIG_FILE }}_firmware_${{ env.Compile_Date }}
        path: openwrt/bin/Firmware

    - name: Upload bin to Artifacts
      uses: actions/upload-artifact@main
      if: env.UPLOAD_BIN_ARTIFACTS == 'true' && env.Compile_Result == 'true' && !cancelled()
      with:
        name: ${{ env.CONFIG_FILE }}_bin_${{ env.Compile_Date }}
        path: openwrt/bin

    - name: Upload Firmware to Release
      uses: svenstaro/upload-release-action@v2
      if: env.UPLOAD_RELEASES == 'true' && env.Compile_Result == 'true' && !cancelled()
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: |
          openwrt/bin/Firmware/*
          openwrt/bin/Firmware/Update_Logs.json
        file_glob: true
        tag: AutoUpdate
        overwrite: true
        
    - name: Download Github API
      if: env.UPLOAD_RELEASES == 'true' && env.Compile_Result == 'true' && !cancelled()
      run: |
        wget https://api.github.com/repos/${{github.repository}}/releases/tags/AutoUpdate -O API
        
    - name: Upload Github API to Release
      if: env.UPLOAD_RELEASES == 'true' && env.Compile_Result == 'true' && !cancelled()
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./API
        file_glob: true
        tag: AutoUpdate
        overwrite: true

    - name: Delete workflow runs
      if: env.DELETE_OLD_WORKFLOW == 'true' && !cancelled()
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
  #      repository: ${{ github.repository }}
        retain_days: 30
        keep_minimum_runs: 3   
        
    - name: Notify DingTalk (Success)
      if: env.Compile_Result == 'true' && !cancelled()   
      env:
        DT_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
        DT_SECRET: ${{ secrets.DINGTALK_SECRET }}
      run: |
        TIMESTAMP=$(date +%s%3N)
        SIGN=$(printf "$TIMESTAMP\n$DT_SECRET" | openssl dgst -sha256 -hmac "$DT_SECRET" -binary | base64)
        curl -X POST \
        "https://oapi.dingtalk.com/robot/send?access_token=$DT_TOKEN&timestamp=$TIMESTAMP&sign=$SIGN" \
        -H 'Content-Type: application/json' \
        -d '{
           "msgtype": "markdown",
           "markdown": {
               "title": "ğŸ‰ ç¼–è¯‘æˆåŠŸé€šçŸ¥",
               "text": "### âœ… RT-AC42U Ilede ç¼–è¯‘æˆåŠŸ \n\n**ğŸ•’ æ—¶é—´**: ${{ env.Display_Date }} \n**ğŸ“¦ ä»“åº“**: [${{ github.repository }}](https://github.com/${{ github.repository }}) \n**ğŸ”¥ çŠ¶æ€**: [æŸ¥çœ‹æ„å»ºè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) \n\n> ğŸ’¡ å›ºä»¶å·²è‡ªåŠ¨ä¸Šä¼ è‡³ Releases"
           },
           "at": {
               "isAtAll": false
           }
         }'

    - name: Notify DingTalk (Failed)
      if: ${{ env.Compile_Result == 'false' || cancelled() }}     
      env: 
        DT_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
        DT_SECRET: ${{ secrets.DINGTALK_SECRET }}
      run: |
       TIMESTAMP=$(date +%s%3N)
       SIGN=$(printf "$TIMESTAMP\n$DT_SECRET" | openssl dgst -sha256 -hmac "$DT_SECRET" -binary | base64)
       curl -X POST \
       "https://oapi.dingtalk.com/robot/send?access_token=$DT_TOKEN&timestamp=$TIMESTAMP&sign=$SIGN" \
       -H 'Content-Type: application/json' \
       -d '{
          "msgtype": "markdown",
          "markdown": {
              "title": "âš ï¸ ç¼–è¯‘å¤±è´¥è­¦æŠ¥",
              "text": "### âŒ RT-AC42U Ilede ç¼–è¯‘å¤±è´¥ \n\n**ğŸ•’ æ—¶é—´**: ${{ env.Display_Date }} \n**ğŸ“¦ ä»“åº“**: [${{ github.repository }}](https://github.com/${{ github.repository }}) \n**ğŸ“ æ—¥å¿—**: [æŸ¥çœ‹é”™è¯¯è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) \n\n> ğŸš¨ è¯·ç«‹å³æ£€æŸ¥ä»£ç æˆ–é…ç½®æ–‡ä»¶ï¼"
           },
           "at": {
               "atMobiles": ["å¯é€‰@çš„æ‰‹æœºå·"],
               "isAtAll": false
            }
          }'
